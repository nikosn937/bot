import streamlit as st
import pandas as pd
from unidecode import unidecode # Î§ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÎµÎ¯Ï„Î±Î¹ Î³Î¹Î± Î½Î± Î±Ï†Î±Î¹ÏÎµÎ¯ Ï„Î¿Ï…Ï‚ Ï„ÏŒÎ½Î¿Ï…Ï‚

# --------------------------
# 1. Î¦ÎŸÎ¡Î¤Î©Î£Î— Î”Î•Î”ÎŸÎœÎ•ÎÎ©Î Î‘Î ÎŸ Î¤ÎŸ Î‘Î¡Î§Î•Î™ÎŸ CSV
# --------------------------

DATA_FILE = 'class_data.csv' 

# Î£Ï…Î½Î¬ÏÏ„Î·ÏƒÎ· Î³Î¹Î± Ï„Î·Î½ Î¿Î¼Î±Î»Î¿Ï€Î¿Î¯Î·ÏƒÎ· Ï„Ï‰Î½ Î»Î­Î¾ÎµÏ‰Î½-ÎºÎ»ÎµÎ¹Î´Î¹ÏÎ½
def normalize_keyword(keyword):
    """ÎœÎµÏ„Î±Ï„ÏÎ­Ï€ÎµÎ¹ Ï„Î· Î»Î­Î¾Î·-ÎºÎ»ÎµÎ¹Î´Î¯ ÏƒÎµ Ï€ÎµÎ¶Î¬ ÎºÎ±Î¹ Î±Ï†Î±Î¹ÏÎµÎ¯ Ï„Î¿Ï…Ï‚ Ï„ÏŒÎ½Î¿Ï…Ï‚."""
    if pd.isna(keyword):
        return ''
    # 1. ÎœÎµÏ„Î±Ï„ÏÎ¿Ï€Î® ÏƒÎµ Ï€ÎµÎ¶Î¬
    # 2. Î‘Ï†Î±Î¯ÏÎµÏƒÎ· Ï„ÏŒÎ½Ï‰Î½ (Ï€.Ï‡. 'Ï†Ï…ÏƒÎ¹ÎºÎ®' -> 'Ï†Ï…ÏƒÎ¹ÎºÎ·')
    return unidecode(str(keyword).lower().strip())

try:
    df = pd.read_csv(DATA_FILE)
    
    # Î•Ï†Î±ÏÎ¼Î¿Î³Î® Ï„Î·Ï‚ Î¿Î¼Î±Î»Î¿Ï€Î¿Î¯Î·ÏƒÎ·Ï‚ ÏƒÏ„Î· ÏƒÏ„Î®Î»Î· Keyword Ï„Î¿Ï… DataFrame
    df['Keyword'] = df['Keyword'].apply(normalize_keyword)
    
    # ÎœÎµÏ„Î±Ï„ÏÎ¿Ï€Î® ÏƒÎµ Î»ÎµÎ¾Î¹ÎºÏŒ Î³Î¹Î± Î³ÏÎ®Î³Î¿ÏÎ· Î±Î½Î±Î¶Î®Ï„Î·ÏƒÎ·
    data_source_dict = df.set_index('Keyword')['Response'].to_dict()
    
except FileNotFoundError:
    st.error("Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ Ï„Î¿ Î±ÏÏ‡ÎµÎ¯Î¿ Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½ 'class_data.csv'. Î’ÎµÎ²Î±Î¹Ï‰Î¸ÎµÎ¯Ï„Îµ ÏŒÏ„Î¹ ÎµÎ¯Î½Î±Î¹ ÏƒÏ„Î¿Î½ Î¯Î´Î¹Î¿ Ï†Î¬ÎºÎµÎ»Î¿.")
    data_source_dict = {}

# --------------------------
# 2. Î¡Î¥Î˜ÎœÎ™Î£Î— UI / Î¤Î™Î¤Î›ÎŸÎ£
# --------------------------
st.set_page_config(page_title="Î’Î¿Î·Î¸ÏŒÏ‚ Î¤Î¬Î¾Î·Ï‚ (Î’ÎµÎ»Ï„Î¹Ï‰Î¼Î­Î½Î¿Ï‚)", layout="centered")
st.title("ğŸ¤– Î¨Î·Ï†Î¹Î±ÎºÏŒÏ‚ Î’Î¿Î·Î¸ÏŒÏ‚ Î¤Î¬Î¾Î·Ï‚")
st.markdown("---")

available_keys = ', '.join(df['Keyword'].unique()).capitalize() if 'Keyword' in df.columns else ""
st.info(f"Î“ÎµÎ¹Î±! Î•Î¯Î¼Î±Î¹ Î¿ Î²Î¿Î·Î¸ÏŒÏ‚ ÏƒÎ¿Ï…. Î”Î¹Î±Î¸Î­ÏƒÎ¹Î¼ÎµÏ‚ Î»Î­Î¾ÎµÎ¹Ï‚-ÎºÎ»ÎµÎ¹Î´Î¹Î¬: {available_keys.replace(',', ', ')}")

# --------------------------
# 3. Î•Î™Î£Î‘Î“Î©Î“Î— Î§Î¡Î—Î£Î¤Î— & Î›ÎŸÎ“Î™ÎšÎ—
# --------------------------

# Î§ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î¿ÏÎ¼Îµ st.session_state Î³Î¹Î± Î½Î± Î±Ï€Î¿Î¸Î·ÎºÎµÏÏƒÎ¿Ï…Î¼Îµ Ï„Î·Î½ Ï„Î¹Î¼Î® Ï„Î¿Ï… Ï€ÎµÎ´Î¯Î¿Ï… ÎµÎ¹ÏƒÎ±Î³Ï‰Î³Î®Ï‚.
if 'search_query' not in st.session_state:
    st.session_state.search_query = ""

# Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Ï„Î¿Ï… Ï€ÎµÎ´Î¯Î¿Ï… ÎµÎ¹ÏƒÎ±Î³Ï‰Î³Î®Ï‚
user_input = st.text_input(
    'Î¤Î¹ Î¸Î­Î»ÎµÎ¹Ï‚ Î½Î± Î¼Î¬Î¸ÎµÎ¹Ï‚;', 
    placeholder='Î Î»Î·ÎºÏ„ÏÎ¿Î»ÏŒÎ³Î·ÏƒÎµ Ï€.Ï‡. ÎœÎ±Î¸Î·Î¼Î±Ï„Î¹ÎºÎ±, Î•ÎºÎ´ÏÎ¿Î¼Î·...',
    key='main_input', # Î”Î¯Î½Î¿Ï…Î¼Îµ Î­Î½Î± ÎºÎ»ÎµÎ¹Î´Î¯ Î³Î¹Î± Ï„Î¿ Ï€ÎµÎ´Î¯Î¿
    value=st.session_state.search_query # Î§ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î¿ÏÎ¼Îµ Ï„Î·Î½ Ï„Î¹Î¼Î® Î±Ï€ÏŒ Ï„Î¿ state
)

if st.button('Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ·'):
    # ÎŸÎ¼Î±Î»Î¿Ï€Î¿Î¯Î·ÏƒÎ· Ï„Î·Ï‚ ÎµÎ¹ÏƒÏŒÎ´Î¿Ï… Ï„Î¿Ï… Ï‡ÏÎ®ÏƒÏ„Î·
    processed_input = normalize_keyword(user_input)
    
    if processed_input in data_source_dict:
        # 4.1. Î•Î¼Ï†Î¬Î½Î¹ÏƒÎ· Î‘Ï€Î¬Î½Ï„Î·ÏƒÎ·Ï‚
        bot_response = data_source_dict[processed_input]
        st.success(f"**Î‘Ï€Î¬Î½Ï„Î·ÏƒÎ·:** {bot_response}")
        
        # 4.2. Î£Î²Î®ÏƒÎ¹Î¼Î¿ Ï„Î·Ï‚ Î»Î­Î¾Î·Ï‚ Î±Î½Î±Î¶Î®Ï„Î·ÏƒÎ·Ï‚ (Î‘Î½Î±Î½ÎµÏÎ½Î¿Ï…Î¼Îµ Ï„Î¿ session state)
        st.session_state.search_query = ""
        st.experimental_rerun() # Î•Ï€Î±Î½ÎµÎºÎºÎ¯Î½Î·ÏƒÎ· Î³Î¹Î± Î½Î± ÎºÎ±Î¸Î±ÏÎ¯ÏƒÎµÎ¹ Ï„Î¿ Ï€ÎµÎ´Î¯Î¿ ÎµÎ¹ÏƒÎ±Î³Ï‰Î³Î®Ï‚
    else:
        st.warning(
            f"Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ Î±Ï€Î¬Î½Ï„Î·ÏƒÎ· Î³Î¹Î± Ï„Î¿: '{user_input}'. Î”Î¿ÎºÎ¹Î¼Î¬ÏƒÏ„Îµ Î¼Î¯Î± Î±Ï€ÏŒ Ï„Î¹Ï‚ Î´Î¹Î±Î¸Î­ÏƒÎ¹Î¼ÎµÏ‚ Î»Î­Î¾ÎµÎ¹Ï‚-ÎºÎ»ÎµÎ¹Î´Î¹Î¬: {available_keys.replace(',', ', ')}."
        )

st.markdown("---")
st.caption("Î¤Î¿ Ï€ÏÏ‰Ï„ÏŒÏ„Ï…Ï€Î¿ Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÎµÎ¯ Python/Streamlit ÎºÎ±Î¹ Î´ÎµÎ´Î¿Î¼Î­Î½Î± Î±Ï€ÏŒ GitHub.")
