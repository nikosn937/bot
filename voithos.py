import streamlit as st
import pandas as pd

# --------------------------------------------------------------------------------
# 1. Î’ÎŸÎ—Î˜Î—Î¤Î™ÎšÎ— Î£Î¥ÎÎ‘Î¡Î¤Î—Î£Î— (Î‘Î¦Î‘Î™Î¡Î•Î£Î— Î¤ÎŸÎÎ©Î Î§Î©Î¡Î™Î£ unidecode)
# --------------------------------------------------------------------------------

# Î§Î¬ÏÏ„Î·Ï‚ Î±Î½Ï„Î¹ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·Ï‚ Î³Î¹Î± Ï„Î¿Ï…Ï‚ Ï„ÏŒÎ½Î¿Ï…Ï‚
TONES_MAP = str.maketrans("Î¬Î­Î®Î¯ÏŒÏÏ", "Î±ÎµÎ·Î¹Î¿Ï…Ï‰")

def normalize_keyword(keyword):
    """ÎœÎµÏ„Î±Ï„ÏÎ­Ï€ÎµÎ¹ Ï„Î· Î»Î­Î¾Î·-ÎºÎ»ÎµÎ¹Î´Î¯ ÏƒÎµ Ï€ÎµÎ¶Î¬, Î±Ï†Î±Î¹ÏÎµÎ¯ Ï„Î± ÎºÎµÎ½Î¬ ÎºÎ±Î¹ Ï„Î¿Ï…Ï‚ Ï„ÏŒÎ½Î¿Ï…Ï‚."""
    if pd.isna(keyword):
        return ''
    normalized = str(keyword).lower().strip()
    return normalized.translate(TONES_MAP)


# --------------------------------------------------------------------------------
# 2. Î¦ÎŸÎ¡Î¤Î©Î£Î— ÎšÎ‘Î™ Î•Î Î•ÎÎ•Î¡Î“Î‘Î£Î™Î‘ Î”Î•Î”ÎŸÎœÎ•ÎÎ©Î Î‘Î ÎŸ CSV
# --------------------------------------------------------------------------------

DATA_FILE = 'class_data.csv' 

try:
    # Î¦ÏŒÏÏ„Ï‰ÏƒÎ· Î¼Îµ ÏÎ·Ï„Î® ÎºÏ‰Î´Î¹ÎºÎ¿Ï€Î¿Î¯Î·ÏƒÎ· utf-8 Î³Î¹Î± Ï„Î± ÎµÎ»Î»Î·Î½Î¹ÎºÎ¬
    df = pd.read_csv(DATA_FILE, encoding='utf-8')
    
    # ÎšÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚ Ï„Ï‰Î½ Î¿Î½Î¿Î¼Î¬Ï„Ï‰Î½ Ï„Ï‰Î½ ÏƒÏ„Î·Î»ÏÎ½
    df.columns = df.columns.str.strip()
    
    # ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ ÏÏ€Î±ÏÎ¾Î·Ï‚ Î±Ï€Î±ÏÎ±Î¯Ï„Î·Ï„Ï‰Î½ ÏƒÏ„Î·Î»ÏÎ½
    if 'Keyword' not in df.columns or 'Response' not in df.columns:
        raise ValueError("Î£Ï†Î¬Î»Î¼Î±: Î¤Î¿ CSV Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± Ï€ÎµÏÎ¹Î­Ï‡ÎµÎ¹ Ï„Î¹Ï‚ ÎµÏ€Î¹ÎºÎµÏ†Î±Î»Î¯Î´ÎµÏ‚ 'Keyword' ÎºÎ±Î¹ 'Response'.")
    
    # Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¿ÏÎ¼Îµ Ï„Î· ÏƒÏ„Î®Î»Î· Î³Î¹Î± ÎµÏƒÏ‰Ï„ÎµÏÎ¹ÎºÎ® ÏƒÏÎ³ÎºÏÎ¹ÏƒÎ· (ÎµÎ´Ï Î³Î¯Î½ÎµÏ„Î±Î¹ Î· Î±Ï†Î±Î¯ÏÎµÏƒÎ· Ï„ÏŒÎ½Ï‰Î½)
    df['Normalized_Keyword'] = df['Keyword'].apply(normalize_keyword)
    
    # ÎœÎµÏ„Î±Ï„ÏÎ¿Ï€Î® ÏƒÎµ Î»ÎµÎ¾Î¹ÎºÏŒ Î³Î¹Î± Î³ÏÎ®Î³Î¿ÏÎ· Î±Î½Î±Î¶Î®Ï„Î·ÏƒÎ·
    data_source_dict = df.set_index('Normalized_Keyword')['Response'].to_dict()
    
    # Î›Î¯ÏƒÏ„Î± Î³Î¹Î± ÎµÎ¼Ï†Î¬Î½Î¹ÏƒÎ·
    available_keys_display = sorted(df['Keyword'].unique())
    
except FileNotFoundError:
    st.error("ÎšÏÎ¯ÏƒÎ¹Î¼Î¿ Î£Ï†Î¬Î»Î¼Î±: Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ Ï„Î¿ Î±ÏÏ‡ÎµÎ¯Î¿ 'class_data.csv' ÏƒÏ„Î¿ GitHub repository.")
    data_source_dict = {}
    available_keys_display = []
except Exception as e:
    st.error(f"ÎšÏÎ¯ÏƒÎ¹Î¼Î¿ Î£Ï†Î¬Î»Î¼Î± Î¦ÏŒÏÏ„Ï‰ÏƒÎ·Ï‚ Î”ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½: {e}")
    data_source_dict = {}
    available_keys_display = []

# --------------------------------------------------------------------------------
# 3. UI / Î›ÎŸÎ“Î™ÎšÎ—
# --------------------------------------------------------------------------------

st.set_page_config(page_title="Î’Î¿Î·Î¸ÏŒÏ‚ Î¤Î¬Î¾Î·Ï‚ (CSV Edition)", layout="centered")
st.title("ğŸ¤– Î¨Î·Ï†Î¹Î±ÎºÏŒÏ‚ Î’Î¿Î·Î¸ÏŒÏ‚ Î¤Î¬Î¾Î·Ï‚ (Î”ÎµÎ´Î¿Î¼Î­Î½Î± Î±Ï€ÏŒ CSV)")
st.markdown("---")

info_message = f"Î“ÎµÎ¹Î±! Î•Î¯Î¼Î±Î¹ Î¿ Î²Î¿Î·Î¸ÏŒÏ‚ ÏƒÎ¿Ï…. Î”Î¹Î±Î¸Î­ÏƒÎ¹Î¼ÎµÏ‚ Î»Î­Î¾ÎµÎ¹Ï‚-ÎºÎ»ÎµÎ¹Î´Î¹Î¬: **{', '.join(available_keys_display)}**"
st.info(info_message)

# Î¤Î¿ Ï€ÎµÎ´Î¯Î¿ ÎµÎ¹ÏƒÎ±Î³Ï‰Î³Î®Ï‚ Î´ÎµÎ½ Ï‡ÏÎµÎ¹Î¬Î¶ÎµÏ„Î±Î¹ session_state Î® ÎºÎ¿Ï…Î¼Ï€Î¯, 
# ÎºÎ±Î¸ÏÏ‚ Î±Ï€Î¿Ï†ÎµÏÎ³Î¿Ï…Î¼Îµ Ï„Î·Î½ ÎµÎ½Ï„Î¿Î»Î® st.rerun() Î³Î¹Î± ÏƒÏ„Î±Î¸ÎµÏÏŒÏ„Î·Ï„Î±.
user_input = st.text_input(
    'Î¤Î¹ Î¸Î­Î»ÎµÎ¹Ï‚ Î½Î± Î¼Î¬Î¸ÎµÎ¹Ï‚;', 
    placeholder='Î Î»Î·ÎºÏ„ÏÎ¿Î»ÏŒÎ³Î·ÏƒÎµ Ï€.Ï‡. ÎœÎ±Î¸Î·Î¼Î±Ï„Î¹ÎºÎ¬, Î•ÎºÎ´ÏÎ¿Î¼Î®...'
)

if user_input: # Î— Î»Î¿Î³Î¹ÎºÎ® ÎµÎºÏ„ÎµÎ»ÎµÎ¯Ï„Î±Î¹ Î¼ÏŒÎ»Î¹Ï‚ Î¿ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚ Ï€Î±Ï„Î®ÏƒÎµÎ¹ Enter
    
    # ÎŸÎ¼Î±Î»Î¿Ï€Î¿Î¯Î·ÏƒÎ· Ï„Î·Ï‚ ÎµÎ¹ÏƒÏŒÎ´Î¿Ï… Ï„Î¿Ï… Ï‡ÏÎ®ÏƒÏ„Î·
    processed_input = normalize_keyword(user_input)
    
    if processed_input in data_source_dict:
        # Î•Ï€Î¹Ï„Ï…Ï‡Î¯Î±
        bot_response = data_source_dict[processed_input]
        st.success(f"**Î‘Ï€Î¬Î½Ï„Î·ÏƒÎ·:** {bot_response}")
        
    else:
        # Î‘Ï€Î¿Ï„Ï…Ï‡Î¯Î±
        st.warning(
            f"Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ Î±Ï€Î¬Î½Ï„Î·ÏƒÎ· Î³Î¹Î± Ï„Î¿: '{user_input}'. Î”Î¿ÎºÎ¯Î¼Î±ÏƒÎµ Î¼Î¯Î± Î±Ï€ÏŒ Ï„Î¹Ï‚ Î´Î¹Î±Î¸Î­ÏƒÎ¹Î¼ÎµÏ‚ Î»Î­Î¾ÎµÎ¹Ï‚-ÎºÎ»ÎµÎ¹Î´Î¹Î¬: **{', '.join(available_keys_display)}**."
        )

st.markdown("---")
st.caption("Î— ÎµÏ†Î±ÏÎ¼Î¿Î³Î® Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÎµÎ¯ Python/Streamlit ÎºÎ±Î¹ Î´ÎµÎ´Î¿Î¼Î­Î½Î± Î±Ï€ÏŒ Ï„Î¿ Î±ÏÏ‡ÎµÎ¯Î¿ class_data.csv.")
